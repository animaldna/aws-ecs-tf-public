version: 2.1
untagged_prod: &untagged_prod
  filters:
    branches:
      only: master
    tags:
      ignore: /^v.*/
  env: prod
  context:
    - org_global
    - catalog_api_prod
tagged_prod: &tagged_prod
  filters:
    branches:
      only: master
    tags:
      only: /^v.*/
stage_env_context: &stage_env_context
  env: stage
  context:
    - org_global
    - catalog_api_dev
prod_env_context: &prod_env_context
  env: prod
  context:
    - org_global
    - catalog_api_prod

workflows:
  untagged_builds:
    jobs:
      - init_and_plan:
          <<: *untagged_prod
          name: prod_init_plan  
      - apply:
          <<: *untagged_prod
          name: prod_apply
          requires:
            - prod_init_plan
  tagged_builds:
    jobs:
      - init_and_plan:
          name: stage_init_plan
          <<: *tagged_prod
          <<: *stage_env_context
      - apply:
          name: stage_apply
          <<: *tagged_prod
          <<: *stage_env_context
          requires:
            - stage_init_plan
      - hold_for_stage_review:
          <<: *tagged_prod
          type: approval
          requires:
            - stage_apply
      - init_and_plan:
          <<: *tagged_prod
          <<: *prod_env_context
          name: prod_init_plan
          requires:
            - hold_for_stage_review
      - hold_for_prod_review:
          <<: *tagged_prod
          type: approval
          requires:
            - prod_init_plan
      - apply:
          <<: *tagged_prod
          <<: *prod_env_context
          name: prod_apply
          requires:
            - hold_for_prod_review
      - destroy:
          <<: *tagged_prod
          <<: *stage_env_context
          name: destroy_stage
          requires:
            - hold_for_prod_review
        
jobs:
  init_and_plan:
    parameters:
      env:
        type: string
        default: dev
    working_directory: /tmp/terraform-infra
    docker:
      - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
    steps:
      - checkout
      - run:
          name: terraform init & plan
          command: |
            terraform init -input=false -backend-config="backends/<< parameters.env >>.s3.tfbackend"
            terraform plan -out="tf-plan-out" \
            -var="env=<< parameters.env >>" \
            -var="aws_region=${AWS_REGION}" \
            -var="aws_account_id=${AWS_ACCOUNT_ID}" \
            -var="safe_ips=${SAFE_IPS}" \
            -var="domain_name=${DOMAIN_NAME}"
      - persist_to_workspace:
          root: .
          paths:
            - .
  apply:
    parameters:
      env:
        type: string
        default: dev
    docker:
      - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
    steps:
      - attach_workspace:
          at: .
      - run:
          name: terraform
          command: |
            terraform apply -auto-approve \
            -var="env=<< parameters.env >>" \
            -var="aws_region=${AWS_REGION}" \
            -var="aws_account_id=${AWS_ACCOUNT_ID}" \
            -var="safe_ips=${SAFE_IPS}" \
            -var="domain_name=${DOMAIN_NAME}"
      - persist_to_workspace:
          root: .
          paths:
            - .
  destroy:
    parameters:
      env:
        type: string
        default: dev
    docker:
      - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
    steps:
      - attach_workspace:
          at: .
      - run:
          name: terraform
          command: |
            terraform destroy -auto-approve \
            -var="env=<< parameters.env >>" \
            -var="aws_region=${AWS_REGION}" \
            -var="aws_account_id=${AWS_ACCOUNT_ID}" \
            -var="safe_ips=${SAFE_IPS}" \
            -var="domain_name=${DOMAIN_NAME}"